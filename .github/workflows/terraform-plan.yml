name: Terraform - plan (PR)

on:
  pull_request:
    branches: ["main"]

permissions:
  contents: read
  pull-requests: write

jobs:
  plan:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: terraform

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_wrapper: false

      - name: Configure AWS credentials (Secrets)
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          echo "AWS creds loaded (region: ${AWS_REGION})"

      - name: Terraform init (no backend)
        run: terraform init -input=false

      - name: Terraform plan
        env:
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          terraform plan -input=false -no-color | tee plan.txt

      - name: Comment plan on PR
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const body = fs.readFileSync('terraform/plan.txt', 'utf8');
            const max = 65000;
            const trimmed = body.length > max ? body.slice(0, max) + "\n\n... (truncated)" : body;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "### Terraform plan\n```\\n" + trimmed + "\\n```"
            });
